<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Integration Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #404040;
        }
        .success { border-color: #10b981; }
        .error { border-color: #ef4444; }
        .warning { border-color: #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        .log {
            background: #1f1f1f;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .status-icon.success { background: #10b981; }
        .status-icon.error { background: #ef4444; }
        .status-icon.warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Supabase Integration Test</h1>
        
        <div class="card">
            <h2>Environment Variables</h2>
            <div id="env-status" class="status">
                <div class="status-icon warning"></div>
                <span>Checking environment variables...</span>
            </div>
            <div id="env-details"></div>
        </div>

        <div class="card">
            <h2>Connection Test</h2>
            <div id="connection-status" class="status">
                <div class="status-icon warning"></div>
                <span>Testing connection...</span>
            </div>
            <button onclick="testConnection()" id="test-btn">Test Connection</button>
            <div id="connection-details"></div>
        </div>

        <div class="card">
            <h2>Storage Bucket Test</h2>
            <div id="storage-status" class="status">
                <div class="status-icon warning"></div>
                <span>Testing storage...</span>
            </div>
            <button onclick="testStorage()" id="storage-btn" disabled>Test Storage</button>
            <div id="storage-details"></div>
        </div>

        <div class="card">
            <h2>File Upload Test</h2>
            <div id="upload-status" class="status">
                <div class="status-icon warning"></div>
                <span>Ready to test upload...</span>
            </div>
            <input type="file" id="test-file" accept="image/*,video/*,audio/*,.glb,.gltf">
            <button onclick="testUpload()" id="upload-btn" disabled>Test Upload</button>
            <div id="upload-details"></div>
        </div>

        <div class="card">
            <h2>Console Log</h2>
            <div id="console-log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let supabase = null;
        let connectionTested = false;

        function log(message) {
            const logElement = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('console-log').textContent = '';
        }

        function updateStatus(elementId, success, message) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('.status-icon');
            const text = element.querySelector('span');
            
            icon.className = `status-icon ${success ? 'success' : 'error'}`;
            text.textContent = message;
        }

        function updateCard(cardId, success, message, details = '') {
            const card = document.getElementById(cardId).closest('.card');
            card.className = `card ${success ? 'success' : 'error'}`;
            
            if (details) {
                const detailsElement = document.getElementById(cardId + '-details');
                detailsElement.innerHTML = details;
            }
        }

        // Check environment variables
        function checkEnvironment() {
            log('Checking environment variables...');
            
            // In a real app, these would come from import.meta.env
            // For this test, we'll check if they're defined in the page
            const url = window.SUPABASE_URL || 'Not set';
            const key = window.SUPABASE_ANON_KEY || 'Not set';
            
            const hasEnvVars = url !== 'Not set' && key !== 'Not set';
            
            updateStatus('env-status', hasEnvVars, 
                hasEnvVars ? 'Environment variables found' : 'Environment variables missing');
            
            document.getElementById('env-details').innerHTML = `
                <p><strong>URL:</strong> ${url}</p>
                <p><strong>Key:</strong> ${key.substring(0, 20)}...</p>
            `;
            
            if (!hasEnvVars) {
                log('‚ùå Environment variables not found. Please set SUPABASE_URL and SUPABASE_ANON_KEY in the browser console.');
                log('Example: window.SUPABASE_URL = "https://your-project.supabase.co"');
                log('Example: window.SUPABASE_ANON_KEY = "your-anon-key"');
            }
            
            return hasEnvVars;
        }

        // Test Supabase connection
        async function testConnection() {
            log('Testing Supabase connection...');
            
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                updateStatus('connection-status', false, 'Environment variables not set');
                log('‚ùå Cannot test connection without environment variables');
                return;
            }

            try {
                supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                
                // Test basic connection
                const { data, error } = await supabase.auth.getUser();
                
                if (error) {
                    log(`‚ö†Ô∏è Auth error (this might be normal): ${error.message}`);
                } else {
                    log('‚úÖ Basic connection successful');
                }
                
                updateStatus('connection-status', true, 'Connection successful');
                connectionTested = true;
                document.getElementById('storage-btn').disabled = false;
                
                log('‚úÖ Supabase connection established');
                
            } catch (error) {
                updateStatus('connection-status', false, 'Connection failed');
                log(`‚ùå Connection failed: ${error.message}`);
            }
        }

        // Test storage bucket
        async function testStorage() {
            log('Testing storage bucket...');
            
            if (!supabase) {
                log('‚ùå No Supabase connection. Test connection first.');
                return;
            }

            try {
                // List buckets
                const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
                
                if (bucketsError) {
                    updateStatus('storage-status', false, 'Cannot access storage');
                    log(`‚ùå Storage access failed: ${bucketsError.message}`);
                    return;
                }
                
                log(`üì¶ Available buckets: ${buckets.map(b => b.name).join(', ')}`);
                
                // Check for files bucket
                const filesBucket = buckets.find(b => b.name === 'files');
                if (!filesBucket) {
                    updateStatus('storage-status', false, 'Files bucket not found');
                    log('‚ùå Files bucket not found. Please create a bucket named "files" in your Supabase dashboard.');
                    return;
                }
                
                log('‚úÖ Files bucket found');
                
                // Test listing files
                const { data: files, error: filesError } = await supabase.storage
                    .from('files')
                    .list('', { limit: 10 });
                
                if (filesError) {
                    updateStatus('storage-status', false, 'Cannot list files');
                    log(`‚ùå Cannot list files: ${filesError.message}`);
                    log('üí° This might be a permissions issue. Check your RLS policies.');
                    return;
                }
                
                updateStatus('storage-status', true, 'Storage working');
                document.getElementById('upload-btn').disabled = false;
                
                log(`‚úÖ Storage test successful. Found ${files.length} files in root.`);
                
            } catch (error) {
                updateStatus('storage-status', false, 'Storage test failed');
                log(`‚ùå Storage test failed: ${error.message}`);
            }
        }

        // Test file upload
        async function testUpload() {
            log('Testing file upload...');
            
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå Please select a file first');
                return;
            }
            
            if (!supabase) {
                log('‚ùå No Supabase connection');
                return;
            }

            try {
                const extension = file.name.split('.').pop()?.toLowerCase() || '';
                const fileName = `test-${Date.now()}.${extension}`;
                const fileType = getFileType(extension);
                const filePath = `${fileType}/${fileName}`;
                
                log(`üì§ Uploading ${file.name} to ${filePath}...`);
                
                const { error: uploadError } = await supabase.storage
                    .from('files')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    updateStatus('upload-status', false, 'Upload failed');
                    log(`‚ùå Upload failed: ${uploadError.message}`);
                    return;
                }
                
                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('files')
                    .getPublicUrl(filePath);
                
                updateStatus('upload-status', true, 'Upload successful');
                log(`‚úÖ Upload successful! Public URL: ${publicUrl}`);
                
                // Clean up test file
                setTimeout(async () => {
                    try {
                        await supabase.storage.from('files').remove([filePath]);
                        log(`üßπ Cleaned up test file: ${fileName}`);
                    } catch (cleanupError) {
                        log(`‚ö†Ô∏è Could not clean up test file: ${cleanupError.message}`);
                    }
                }, 5000);
                
            } catch (error) {
                updateStatus('upload-status', false, 'Upload test failed');
                log(`‚ùå Upload test failed: ${error.message}`);
            }
        }

        function getFileType(extension) {
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(extension)) return 'images';
            if (['mp4', 'webm', 'mov', 'avi'].includes(extension)) return 'videos';
            if (['mp3', 'wav', 'ogg', 'flac'].includes(extension)) return 'audio';
            if (['glb', 'gltf', 'obj', 'fbx'].includes(extension)) return '3d';
            return 'other';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Supabase Integration Test Started');
            checkEnvironment();
        });
    </script>
</body>
</html> 