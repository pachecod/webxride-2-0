<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebVR A-Frame Tour</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://aframe.io/releases/1.7.0/aframe-inspector.min.js"></script>
    <script src="script.js"></script>
    <style>
      a-text { font-family: Arial; font-weight: bold; }
      
      /* Animation for gaze feedback */
      @keyframes hotspotPulse {
        0% { opacity: 0.8; }
        50% { opacity: 1.0; }
        100% { opacity: 0.8; }
      }
      
      .hotspot-animation {
        animation: hotspotPulse 2s infinite;
      }
      
      /* Start overlay styles */
      #start-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        font-family: Arial, sans-serif;
      }
      
      #start-button {
        background: #0088FF;
        color: white;
        border: none;
        padding: 20px 40px;
        font-size: 24px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.3s;
      }
      
      #start-button:hover {
        background: #0066CC;
      }
      
      .hidden {
        display: none !important;
      }
      
      /* A-Frame Inspector Button */
      #aframe-inspector-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        display: none; /* Hidden by default, shown in fullscreen */
      }
      
      #aframe-inspector-btn:hover {
        background: rgba(59, 130, 246, 0.8);
        transform: scale(1.1);
      }
      
      /* Show inspector button in fullscreen */
      @media (display-mode: fullscreen) {
        #aframe-inspector-btn {
          display: flex !important;
        }
      }
    </style>
    <script>
      // A-Frame Inspector functionality
      function addAframeInspectorButton() {
        // Check if we're in fullscreen or if this is an A-Frame page
        const isFullscreen = document.fullscreenElement || 
                           document.webkitFullscreenElement || 
                           document.msFullscreenElement ||
                           window.innerHeight === screen.height;
        
        const hasAframe = document.querySelector('a-scene') || 
                         document.querySelector('script[src*="aframe"]');
        
        if (isFullscreen || hasAframe) {
          // Create inspector button if it doesn't exist
          if (!document.getElementById('aframe-inspector-btn')) {
            const inspectorButton = document.createElement('button');
            inspectorButton.id = 'aframe-inspector-btn';
            inspectorButton.innerHTML = '⚙️';
            inspectorButton.title = 'Open A-Frame Inspector';
            
            inspectorButton.addEventListener('click', () => {
              console.log('A-Frame Inspector button clicked');
              try {
                console.log('Checking A-Frame availability...');
                console.log('window.AFRAME:', window.AFRAME);
                console.log('window.AFRAME.inspector:', window.AFRAME?.inspector);
                
                // Method 1: Try direct AFRAME.inspector access
                if (window.AFRAME && window.AFRAME.inspector) {
                  console.log('Opening inspector via AFRAME.inspector');
                  window.AFRAME.inspector.open();
                  return;
                }
                
                // Method 2: Try to load inspector manually if not available
                if (window.AFRAME && !window.AFRAME.inspector) {
                  console.log('A-Frame found but no inspector, trying to load it...');
                  const script = document.createElement('script');
                  script.src = 'https://aframe.io/releases/1.7.0/aframe-inspector.min.js';
                  script.onload = function() {
                    console.log('Inspector script loaded, trying to open...');
                    if (window.AFRAME && window.AFRAME.inspector) {
                      window.AFRAME.inspector.open();
                    }
                  };
                  document.head.appendChild(script);
                  return;
                }
                
                // Method 3: Check scene inspector
                const scene = document.querySelector('a-scene');
                console.log('Scene found:', scene);
                if (scene && scene.inspector) {
                  console.log('Opening inspector via scene.inspector');
                  scene.inspector.open();
                  return;
                }
                
                // Method 4: Try keyboard shortcut simulation
                console.log('Attempting keyboard shortcut simulation...');
                const keyEvent = new KeyboardEvent('keydown', {
                  key: 'i',
                  code: 'KeyI',
                  ctrlKey: true,
                  altKey: true,
                  bubbles: true,
                  cancelable: true
                });
                document.dispatchEvent(keyEvent);
                
                // Method 5: Try to trigger the inspector via the scene's systems
                if (scene && scene.systems && scene.systems.inspector) {
                  console.log('Opening inspector via scene.systems.inspector');
                  scene.systems.inspector.open();
                  return;
                }
                
                console.log('All inspector opening methods attempted');
                alert('A-Frame Inspector could not be opened. Please try Ctrl+Alt+I (or Cmd+Option+I on Mac) directly in the experience.');
              } catch (error) {
                console.error('Failed to open A-Frame Inspector:', error);
                alert('Error opening A-Frame Inspector: ' + error.message);
              }
            });
            
            document.body.appendChild(inspectorButton);
          }
          
          // Show the button
          const btn = document.getElementById('aframe-inspector-btn');
          if (btn) {
            btn.style.display = 'flex';
          }
        }
      }
      
      // Add inspector button when page loads
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(addAframeInspectorButton, 1000); // Give A-Frame time to load
      });
      
      // Also check when entering fullscreen
      document.addEventListener('fullscreenchange', addAframeInspectorButton);
      document.addEventListener('webkitfullscreenchange', addAframeInspectorButton);
      document.addEventListener('msfullscreenchange', addAframeInspectorButton);
    </script>
  </head>

  <body>
    <!-- Start overlay -->
    <div id="start-overlay">
      <button id="start-button">Start VR Tour</button>
    </div>

    <a-scene background="color: #ECECEC">
      <!-- Assets -->
      <a-assets>

        <!-- Panoramas -->
        <img id="point1" src="./images/1.jpg" />
        <img id="point2" src="./images/2.jpg" />

        <!-- Hotspot icon -->
        <img id="hotspot" src="./images/hotspot_yellow.png" />
        
        <!-- Narration tracks -->
        <audio id="audio1" src="./audio/cars.mp3" preload="auto"></audio>
        <audio id="audio2" src="./audio/hi.mp3" preload="auto"></audio>
        
        <!-- Play/Pause icons -->
        <img id="play" src="./images/play.png" />
        <img id="pause" src="./images/pause.png" />
        
        <!-- Cursor ring for gaze -->
        <img id="ring" src="./images/ring.png" />
      
      </a-assets>

      <!-- Hotspot groups -->
      <a-entity id="spots">
        <!-- Group 1: In a Tree → front of mosque -->
        <a-entity id="group-point1" visible="true">
          <a-image
            class="clickable"
            src="#hotspot"
            position="0 1.6 -2"
            scale="0.6 0.6 0.6"
            spot="linkto:#point2;
                  spotgroup:#group-point2;
                  audio:#audio1;
                  popup:We seem to be in the middle of a tree!;
                  popupColor:#F0F0F0"
          >
            <!-- Controls for this hotspot -->
            <a-entity position="0 -1 0">
              <!-- Play/Pause buttons -->
              <a-image
                class="clickable"
                src="#play"
                position="-0.5 0 0"
                width="0.5"
                height="0.5"
                play-audio="panorama:group-point1"
              ></a-image>
              <a-image
                class="clickable"
                src="#pause"
                position="0.5 0 0"
                width="0.5"
                height="0.5"
                pause-audio="panorama:group-point1"
              ></a-image>
              
              <!-- Read Description button -->
              <a-entity position="0 -0.6 0">
                <a-plane
                  color="#0088FF"
                  width="1.5"
                  height="0.5"
                  opacity="0.8"
                  class="clickable"
                  show-description="panorama:group-point1;
                                  text:We seem to be in the middle of some trees."
                ></a-plane>
                <a-text
                  value="Caption"
                  align="center"
                  color="white"
                  width="4"
                  position="0 0.35 0.7"
                ></a-text>
              </a-entity>
            </a-entity>
          </a-image>
        </a-entity>
        

        <!-- Group 2: Front of mosque → Back to trees -->
        <a-entity id="group-point2" visible="false">
          <a-image
            class="clickable"
            src="#hotspot"
            position="-1 1.6 -2"
            scale="0.6 0.6 0.6"
            spot="linkto:#point1;
                  spotgroup:#group-point1;
                  audio:#audio2;
                  popup:This is the front of the mosque;
                  popupColor:#F0F0F0"
          >
            <!-- Controls for this hotspot -->
            <a-entity position="0 -1 0">
              <!-- Play/Pause buttons -->
              <a-image
                class="clickable"
                src="#play"
                position="-0.5 0 0"
                width="0.5"
                height="0.5"
                play-audio="panorama:group-point2"
              ></a-image>
              <a-image
                class="clickable"
                src="#pause"
                position="0.5 0 0"
                width="0.5"
                height="0.5"
                pause-audio="panorama:group-point2"
              ></a-image>
              
              <!-- Read Description button -->
              <a-entity position="0 -0.6 0">
                <a-plane
                  color="#0088FF"
                  width="1.5"
                  height="0.5"
                  opacity="0.8"
                  class="clickable"
                  show-description="panorama:group-point2;
                                  text:This is the front of the mosque"
                ></a-plane>
                <a-text
                  value="Caption"
                  align="center"
                  color="white"
                  width="4"
                  position="0.2 0.35 0.7"
                ></a-text>
              </a-entity>
            </a-entity>
          </a-image>
        </a-entity>
      </a-entity>

      <!-- The sky (panorama) -->
      <a-sky id="skybox" src="#point1"></a-sky>

      <!-- Camera with both mouse and gaze-based cursors and raycaster -->
      <a-entity id="cam" camera look-controls position="0 1.6 0">
        <!-- Mouse-based cursor for non-VR mode -->
        <a-entity 
          cursor="rayOrigin: mouse; fuse: false"
          raycaster="objects: .clickable; far: 10"
          id="mouse-cursor"
          visible="true">
        </a-entity>
        
        <!-- Gaze-based cursor for VR mode - ENABLED for gaze/fuse -->
        <a-entity
          cursor="fuse: true; fuseTimeout: 1500"
          raycaster="objects: .clickable; far: 10"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
          material="color: white; shader: flat"
          id="gaze-cursor"
          visible="true">
        </a-entity>
      </a-entity>
    </a-scene>
    
    <script>
      let audioEnabled = false;
      let currentAudio = null;

      document.addEventListener('DOMContentLoaded', function() {
        
        // Handle start button click
        const startButton = document.getElementById('start-button');
        const startOverlay = document.getElementById('start-overlay');
        
        startButton.addEventListener('click', function() {
          // Enable audio context with user interaction
          enableAudio().then(() => {
            audioEnabled = true;
            startOverlay.classList.add('hidden');
            
            // Do NOT auto-play audio here
          });
        });
        
        // Function to enable audio context and preload audio
        function enableAudio() {
          return new Promise((resolve) => {
            const audioElements = document.querySelectorAll('audio');
            let loadedCount = 0;
            
            function checkAllLoaded() {
              loadedCount++;
              if (loadedCount === audioElements.length) {
                console.log('All audio files ready');
                resolve();
              }
            }
            
            audioElements.forEach(audio => {
              // Ensure audio is loaded
              if (audio.readyState >= 2) {
                checkAllLoaded();
              } else {
                audio.addEventListener('canplay', checkAllLoaded, { once: true });
                audio.load(); // Force load
              }
            });
            
            // Fallback in case some audio doesn't load
            setTimeout(() => {
              console.log('Audio loading timeout - proceeding anyway');
              resolve();
            }, 3000);
          });
        }
        
        // Improved function to play audio for a specific panorama
        function playAudioForPanorama(panoramaId) {
          if (!audioEnabled) {
            console.log('Audio not enabled yet');
            return Promise.resolve(false);
          }
          
          return new Promise((resolve) => {
            // Stop current audio if playing
            if (currentAudio) {
              currentAudio.pause();
              currentAudio.currentTime = 0;
            }
            
            // Get the new audio element
            const audioElement = document.getElementById(panoramaId);
            if (audioElement) {
              // Wait a moment for any previous audio to fully stop
              setTimeout(() => {
                audioElement.play()
                  .then(() => {
                    currentAudio = audioElement;
                    console.log('Successfully playing:', panoramaId);
                    resolve(true);
                  })
                  .catch(e => {
                    console.log('Audio play failed for', panoramaId, ':', e);
                    resolve(false);
                  });
              }, 100);
            } else {
              console.log('Audio element not found:', panoramaId);
              resolve(false);
            }
          });
        }
        
        // Function to properly switch between hotspot groups
        function switchToGroup(targetGroupId) {
          // Hide all groups first
          document.querySelectorAll('[id^="group-point"]').forEach(group => {
            group.setAttribute('visible', 'false');
          });
          
          // Show the target group after a brief delay
          setTimeout(() => {
            const targetGroup = document.getElementById(targetGroupId);
            if (targetGroup) {
              targetGroup.setAttribute('visible', 'true');
              
              // Play corresponding audio only if audio is enabled
              if (audioEnabled) {
                if (targetGroupId === 'group-point1') {
                  playAudioForPanorama('audio1');
                } else if (targetGroupId === 'group-point2') {
                  playAudioForPanorama('audio2');
                }
              }
            }
          }, 50);
        }
        
        // Listen for panorama changes and play corresponding audio
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'visible') {
              const target = mutation.target;
              if (target.getAttribute('visible') === 'true' && audioEnabled) {
                console.log('Group became visible:', target.id);
                
                // Play audio for the visible group
                if (target.id === 'group-point1') {
                  playAudioForPanorama('audio1');
                } else if (target.id === 'group-point2') {
                  playAudioForPanorama('audio2');
                }
              }
            }
          });
        });
        
        // Observe visibility changes on hotspot groups
        document.querySelectorAll('[id^="group-point"]').forEach(group => {
          observer.observe(group, { attributes: true, attributeFilter: ['visible'] });
        });
        
        // Also listen for skybox changes as a backup
        const skybox = document.getElementById('skybox');
        if (skybox) {
          const skyboxObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'src' && audioEnabled) {
                const newSrc = skybox.getAttribute('src');
                if (newSrc === '#point1') {
                  playAudioForPanorama('audio1');
                } else if (newSrc === '#point2') {
                  playAudioForPanorama('audio2');
                }
              }
            });
          });
          skyboxObserver.observe(skybox, { attributes: true, attributeFilter: ['src'] });
        }
        
        // Make functions available globally for custom components
        window.playAudioForPanorama = playAudioForPanorama;
        window.switchToGroup = switchToGroup;
      });
    </script>
  </body>
</html>