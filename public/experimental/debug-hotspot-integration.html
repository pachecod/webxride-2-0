<!DOCTYPE html>
<html>
<head>
    <title>Debug Hotspot Integration</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .debug-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #45a049;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
        .warning { background: #ff9800; }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #444;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Debug Hotspot Integration</h1>
    
    <div class="debug-section">
        <h3>Step 1: Test Direct Editor Access</h3>
        <button class="btn" onclick="openDirectEditor()">Open Editor Directly</button>
        <button class="btn" onclick="openWebXRideEditor()">Open Editor with WebXRide Param</button>
        <div id="direct-status" class="status info">Click to test direct access</div>
    </div>
    
    <div class="debug-section">
        <h3>Step 2: Test Bridge Integration</h3>
        <button class="btn" onclick="testBridgeLaunch()">Launch via Bridge</button>
        <div id="bridge-status" class="status info">Click to test bridge launch</div>
    </div>
    
    <div class="debug-section">
        <h3>Step 3: Manual WebXRide Mode</h3>
        <button class="btn" onclick="enableWebXRideMode()">Enable WebXRide Mode</button>
        <div id="manual-status" class="status info">Click to manually enable WebXRide mode</div>
    </div>
    
    <div class="debug-section">
        <h3>Step 4: Test Communication</h3>
        <button class="btn" onclick="testMessageToEditor()">Test Message to Editor</button>
        <button class="btn" onclick="checkEditorStatus()">Check Editor Status</button>
        <button class="btn" onclick="clearLog()">Clear Log</button>
        <div id="test-status" class="status info">Click to test communication</div>
    </div>
    
    <div class="debug-section">
        <h3>Editor Preview</h3>
        <div id="editor-container">
            <p>Editor will appear here when launched</p>
        </div>
    </div>
    
    <div class="debug-section">
        <h3>Console Log</h3>
        <div id="console-log" style="background: #333; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            No logs yet...
        </div>
    </div>

    <script>
        let bridge = null;
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const logDiv = document.getElementById('console-log');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logDiv.innerHTML += `<div style="color: #4CAF50;">LOG: ${args.join(' ')}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logDiv.innerHTML += `<div style="color: #f44336;">ERROR: ${args.join(' ')}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        // Listen for messages from the editor
        window.addEventListener('message', (event) => {
          // Filter out MetaMask extension messages
          if (event.data && typeof event.data === 'object' && 
              (event.data.target === 'metamask-inpage' || event.data.target === 'metamask-contentscript')) {
            return; // Skip MetaMask messages
          }
          
          console.log('Received message from editor:', event.data);
          console.log('Message type:', typeof event.data);
          console.log('Message keys:', event.data ? Object.keys(event.data) : 'null');
          
          // Try to parse the message data
          let messageData = event.data;
          if (typeof messageData === 'string') {
            try {
              messageData = JSON.parse(messageData);
            } catch (e) {
              // If it's not JSON, just use the string
            }
          }
          
          // Log the parsed message
          if (messageData && typeof messageData === 'object') {
            console.log('Message type:', messageData.type);
            console.log('Message data:', messageData.data || messageData);
            
            // Handle specific message types
            if (messageData.type === 'HOTSPOT_CREATED') {
              logStatus('Hotspot created: ' + JSON.stringify(messageData.data));
            } else if (messageData.type === 'SCENE_ADDED') {
              logStatus('Scene added: ' + JSON.stringify(messageData.data));
            } else if (messageData.type === 'EDITOR_READY') {
              logStatus('Editor is ready and functional');
            } else if (messageData.type === 'WEBXRIDE_INTEGRATION_READY') {
              logStatus('WebXRide integration is ready');
            } else if (messageData.type === 'TEST_RESPONSE') {
              logStatus('Test response received: ' + JSON.stringify(messageData.data));
            } else if (messageData.type === 'STATUS_RESPONSE') {
              logStatus('Status response: ' + JSON.stringify(messageData.data));
            } else if (messageData.type === 'WEBXRIDE_CONTEXT') {
              logStatus('WebXRide context received');
            } else if (messageData.type) {
              logStatus('Known message type: ' + messageData.type);
            } else {
              // No type field, check if it's a direct message
              if (messageData.ACK) {
                logStatus('ACK received from editor');
              } else if (messageData.message) {
                logStatus('Message: ' + messageData.message);
              } else {
                logStatus('Unknown message structure: ' + JSON.stringify(messageData));
              }
            }
          } else {
            logStatus('Received non-object message: ' + typeof messageData);
          }
        });
        
        function openDirectEditor() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '<iframe src="./webxride-enhanced-hotspot-editor/index.html"></iframe>';
            document.getElementById('direct-status').textContent = 'Editor opened directly';
            document.getElementById('direct-status').className = 'status success';
        }
        
        function openWebXRideEditor() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '<iframe src="./webxride-enhanced-hotspot-editor/index.html?webxride=true"></iframe>';
            document.getElementById('direct-status').textContent = 'Editor opened with WebXRide parameter';
            document.getElementById('direct-status').className = 'status success';
        }
        
        function testBridgeLaunch() {
            if (!bridge) {
                // Load bridge with correct path
                const script = document.createElement('script');
                script.src = './webxride-integrations/hotspot-template-bridge.js?v=1.0.1';
                script.onload = () => {
                    console.log('Bridge script loaded, checking for HotspotTemplateBridge...');
                    if (window.HotspotTemplateBridge) {
                        console.log('Creating bridge instance...');
                        bridge = new window.HotspotTemplateBridge();
                        bridge.initialize({
                            currentUser: 'test-user',
                            isAdmin: true
                        });
                        console.log('Bridge initialized, launching editor...');
                        bridge.launchEditor('webxride-enhanced');
                        document.getElementById('bridge-status').textContent = 'Bridge launched editor';
                        document.getElementById('bridge-status').className = 'status success';
                    } else {
                        console.error('HotspotTemplateBridge not found in window object');
                        document.getElementById('bridge-status').textContent = 'Bridge class not found';
                        document.getElementById('bridge-status').className = 'status error';
                    }
                };
                script.onerror = (error) => {
                    console.error('Failed to load bridge script:', error);
                    document.getElementById('bridge-status').textContent = 'Failed to load bridge script';
                    document.getElementById('bridge-status').className = 'status error';
                };
                document.head.appendChild(script);
            } else {
                bridge.launchEditor('webxride-enhanced');
                document.getElementById('bridge-status').textContent = 'Bridge launched editor';
                document.getElementById('bridge-status').className = 'status success';
            }
        }
        
        function enableWebXRideMode() {
            const iframe = document.querySelector('iframe');
            if (iframe && iframe.contentWindow) {
                try {
                    iframe.contentWindow.enableWebXRideMode();
                    document.getElementById('manual-status').textContent = 'WebXRide mode enabled manually';
                    document.getElementById('manual-status').className = 'status success';
                } catch (error) {
                    console.error('Error enabling WebXRide mode:', error);
                    document.getElementById('manual-status').textContent = 'Error: ' + error.message;
                    document.getElementById('manual-status').className = 'status error';
                }
            } else {
                document.getElementById('manual-status').textContent = 'No iframe found';
                document.getElementById('manual-status').className = 'status error';
            }
        }
        
        function testMessageToEditor() {
            const iframe = document.querySelector('iframe');
            if (iframe && iframe.contentWindow) {
                try {
                    const testMessage = {
                        type: 'TEST_MESSAGE',
                        data: {
                            message: 'Hello from debug page!',
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    iframe.contentWindow.postMessage(testMessage, '*');
                    document.getElementById('test-status').textContent = 'Test message sent to editor';
                    document.getElementById('test-status').className = 'status success';
                    console.log('Test message sent:', testMessage);
                } catch (error) {
                    console.error('Error sending test message:', error);
                    document.getElementById('test-status').textContent = 'Error: ' + error.message;
                    document.getElementById('test-status').className = 'status error';
                }
            } else {
                document.getElementById('test-status').textContent = 'No iframe found';
                document.getElementById('test-status').className = 'status error';
            }
        }
        
        function checkEditorStatus() {
            const iframe = document.querySelector('iframe');
            if (iframe && iframe.contentWindow) {
                try {
                    const statusMessage = {
                        type: 'CHECK_STATUS',
                        data: { requestId: Date.now() }
                    };
                    
                    iframe.contentWindow.postMessage(statusMessage, '*');
                    document.getElementById('test-status').textContent = 'Status check sent to editor';
                    document.getElementById('test-status').className = 'status info';
                    console.log('Status check sent:', statusMessage);
                } catch (error) {
                    console.error('Error checking editor status:', error);
                    document.getElementById('test-status').textContent = 'Error: ' + error.message;
                    document.getElementById('test-status').className = 'status error';
                }
            } else {
                document.getElementById('test-status').textContent = 'No iframe found';
                document.getElementById('test-status').className = 'status error';
            }
        }
        
        function clearLog() {
            document.getElementById('console-log').innerHTML = 'Log cleared...';
            document.getElementById('test-status').textContent = 'Log cleared';
            document.getElementById('test-status').className = 'status info';
        }
        
        function logStatus(message) {
            document.getElementById('test-status').textContent = message;
            document.getElementById('test-status').className = 'status success';
        }
    </script>
</body>
</html> 